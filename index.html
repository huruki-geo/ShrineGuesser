<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>神社 Guesser</title>
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css"
    rel="stylesheet"
    integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC"
    crossorigin="anonymous"
  />
  <style>
    body {
      background-color: #f0f8ff;
      font-family: 'Comic Sans MS', cursive, sans-serif;
      color: #333;
      text-align: center;
      padding: 20px;
    }

    h1 {
      font-size: 3rem;
      font-weight: bold;
      color: #ff4500;
      text-shadow: 2px 2px #ffa07a;
    }

    h2 {
      font-size: 2rem;
      color: #1e90ff;
      margin-bottom: 20px;
    }

    button {
      background: linear-gradient(45deg, #ff7f50, #ff4500);
      color: #fff;
      border: none;
      padding: 10px 20px;
      font-size: 1.2rem;
      border-radius: 10px;
      cursor: pointer;
      transition: transform 0.2s, box-shadow 0.2s;
    }

    button:hover {
      transform: scale(1.1);
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
    }

    #options button {
      margin: 10px;
    }

    #loading {
      font-size: 1.5rem;
      color: #ff6347;
    }

    #map-container img {
      border: 5px solid #1e90ff;
      border-radius: 15px;
      margin-top: 20px;
    }

    #scoreList {
      list-style: none;
      padding: 0;
    }

    #scoreList li {
      background: #ffe4b5;
      margin: 10px auto;
      padding: 10px;
      border-radius: 5px;
      box-shadow: 2px 2px 5px rgba(0, 0, 0, 0.2);
    }
  </style>
</head>
<body>
  <h1>神社 Guesser</h1>
  <div id="loading" style="display: none;">読み込み中...</div>
  <div class="game-mode" id="game-mode-selection">
    <h2>ゲームモードを選択してください</h2>
    <button onclick="startGame('guess-location')">神社の場所を当てる</button>
    <button onclick="startGame('guess-name')">どれがあてはまる神社？</button>
  </div>

  <div class="question" id="question" style="display: none;">
    <h2 id="game-title"></h2>
    <p id="question-text">ここに問題が表示されます。</p>
    <div id="options" style="display: none;"></div>
    <div id="map-container" style="display: none;">
      <img src="Japanmap.svg" id="japan-map" alt="日本地図" width="800" height="800">
    </div>
    <button id="submit-button" onclick="submitAnswer()" style="display: none;">決定</button>
  </div>
  
  <h1>Scoreboard</h1>
  <button id="loadScores">スコアを取得する</button>
  <ul id="scoreList"></ul>

  <div id="result-screen" style="display: none;">
    <h2>ゲーム終了！</h2>
    <p>合計スコア: <span id="final-score"></span></p>
    <form id="score-form">
        <div class="form-group">
      <label for="player-name">名前を入力してください:</label>
        <input type="text" id="player-name" name="player-name" class="form-control" required>
      <button type="button" onclick="submitFinalScore()">スコアを送信</button>
        </div>
    </form>
    <a href="" rel="nofollow" target="_blank" id="twitter">Twitterでシェア</a>
  </div>
  <br>
  <br>
  <br>
  <br>
  <br>
  <footer class="bg-dark fixed-bottom">
  <div class='container mt-5'>
  	<div class='row'>
    	<div class='mx-auto text-white'>
    	　<p>このクイズはWikipediaのテキストを改変し利用しています。 ver0.30</p>
    	</div>
    </div>
  </div>
</footer>
</body>

<script>
  const apiBaseUrl = 'https://script.google.com/macros/s/AKfycbw5cStUtPAC8pOm3ytdgtcSJWTu0E-5Ljc0bpX07yyQ7WzBYbHZSmvMuFkW0ByBf87J/exec'; // APIのベースURL
  let currentGameMode = null;
  let currentQuestions = [];
  let currentIndex = 0;
  let currentScore = 0;
  let selectedPosition = null;

  const LAT_MIN = 24.0;
  const LAT_MAX = 46.0;
  const LON_MIN = 123.0;
  const LON_MAX = 146.0;
  const twitter=document.getElementById("twitter");
  const scoreList = document.getElementById("scoreList");
  const loadScoresButton = document.getElementById("loadScores");
  loadScoresButton.addEventListener("click", async () => {
    const response = await fetch("https://script.google.com/macros/s/AKfycbzWwnXWQ_dxaT3vkZI36DSM3Q3NlKaSTrgTEjEKjnrC-qMpmf_Uvj67Ym_JJrOI03l7/exec");
    const scores = await response.json();

    scoreList.innerHTML = "";

    scores.forEach((score) => {
      const listItem = document.createElement("li");
      listItem.textContent = `${score.name}: ${score.score} (Date: ${score.date}) `;
      scoreList.appendChild(listItem);
    });
  });

  async function startGame(mode) {
    currentGameMode = mode;
    currentScore = 0;
    currentIndex = 0;

    document.getElementById('game-mode-selection').style.display = 'none';
    document.getElementById('loading').style.display = 'block';

    try {
      await fetchQuestions();
      document.getElementById('loading').style.display = 'none';
      document.getElementById('question').style.display = 'block';

      if (mode === 'guess-location') {
        document.getElementById('game-title').textContent = '神社の場所を当てる';
        document.getElementById('map-container').style.display = 'block';
      } else {
        document.getElementById('game-title').textContent = 'どれが正しい神社？';
        document.getElementById('options').style.display = 'block';
      }

      displayQuestion();
    } catch (error) {
      alert('データの取得に失敗しました。');
      console.error(error);
    }
  }

  async function fetchQuestions() {
    const response = await fetch(`${apiBaseUrl}?mode=game&count=10`);
    const data = await response.json();
    currentQuestions = data;
  }

  function displayQuestion() {
    const question = currentQuestions[currentIndex].correct.data;
    const questionText = document.getElementById('question-text');

    if (currentGameMode === 'guess-location') {
      questionText.textContent = `この神社はどこにありますか？ (${question['名称']}, 祭神: ${question['祭神']}, 創建: ${question['創建']}, 旧社格: ${question['旧社格']}, 様式: ${question['様式']})`;
      document.getElementById('submit-button').style.display = 'block';
      resetMap();
    } else {
      questionText.textContent = `次のうち、あてはまる神社の名前はどれですか？ (祭神: ${question['祭神']}, 創建: ${question['創建']}, 旧社格: ${question['旧社格']}, 様式: ${question['様式']})`;
      displayOptions(question);
    }
  }

  function resetMap() {
    const map = document.getElementById('map-container');
    map.addEventListener('click', event => {
      const rect = map.getBoundingClientRect();
      const x = event.clientX - rect.left;
      const y = event.clientY - rect.top;

      selectedPosition = { x, y };

      const existingPin = document.getElementById('selected-pin');
      if (existingPin) existingPin.remove();

      const pin = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
      pin.setAttribute('id', 'selected-pin');
      pin.setAttribute('cx', x);
      pin.setAttribute('cy', y);
      pin.setAttribute('r', 5);
      pin.setAttribute("z-index",9999);
      pin.setAttribute('fill', 'blue');
      map.appendChild(pin);
    });
  }

  function submitAnswer() {
    if (!selectedPosition) {
      alert('地図上で位置を選択してください。');
      return;
    }

    const { 北緯: lat, 東経: lon } = currentQuestions[currentIndex].correct.data;
    if (!lat || !lon) {
      alert('正解データが不正です。');
      return;
    }

    const shrinePosition = latLonToXY(lat, lon);

    const dx = selectedPosition.x - shrinePosition.x;
    const dy = selectedPosition.y - shrinePosition.y;
    const distance = Math.sqrt(dx ** 2 + dy ** 2);

    const score = Math.max(0, 100 - Math.floor(distance / 2));
    currentScore += score;

    alert(`得点: ${score}点 (距離: ${distance.toFixed(2)}px)  所在地は${currentQuestions[currentIndex].correct.data["所在地"]}`);

    nextQuestion();
  }

  function latLonToXY(lat, lon) {
    const x = ((lon - LON_MIN) / (LON_MAX - LON_MIN)) * 800;
    const y = 800 - ((lat - LAT_MIN) / (LAT_MAX - LAT_MIN)) * 800;
    return { x, y };
  }

  function displayOptions(question) {
    const optionsDiv = document.getElementById('options');
    optionsDiv.innerHTML = '';

    const currentOptions = shuffle([currentQuestions[currentIndex].correct.name, ...currentQuestions[currentIndex].wrong]);
    currentOptions.forEach(option => {
      const button = document.createElement('button');
      button.textContent = option;
      button.onclick = () => handleAnswer(option);
      optionsDiv.appendChild(button);
    });
  }

  function handleAnswer(selectedOption) {
    if (selectedOption === currentQuestions[currentIndex].correct.name) {
      currentScore += 10;
      alert('正解です！');
    } else {
      alert(`不正解！正解は ${currentQuestions[currentIndex].correct.data["所在地"]}にある、${currentQuestions[currentIndex].correct.name} です。`);
    }

    nextQuestion();
  }

  function nextQuestion() {
    currentIndex++;
    if (currentIndex < currentQuestions.length) {
      displayQuestion();
    } else {
      endGame();
    }
  }

  function endGame() {
    document.getElementById('question').style.display = 'none';
    document.getElementById('result-screen').style.display = 'block';
    document.getElementById('final-score').textContent = currentScore;
    twitter.href=`https://x.com/intent/post?text=神社Guesserで${currentScore}を獲得しました！`
  }

  async function submitFinalScore() {
    const playerName = document.getElementById('player-name').value;
    if (!playerName) {
      alert('名前を入力してください。');
      return;
    }

    await fetch(`https://script.google.com/macros/s/AKfycbyq1eRzCd_gfZzu4V2fGS0Jg6bvXYDsbHOWTUfX5bYeOt4xcfld_R1SSo3sfRSsBozj/exec`, {
        method: 'POST',
        mode: "no-cors",
        headers: {
          'Content-Type': 'application/x-www-form-urlencoded',
        },
        body: JSON.stringify({ name : playerName, score : currentScore }),
      });

    alert('スコアが送信されました！');
    location.reload();
  }

  function shuffle(array) {
    return array.sort(() => Math.random() - 0.5);
  }
</script>

  <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM"
      crossorigin="anonymous"
    ></script>
</html>

