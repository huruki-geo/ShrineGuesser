<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>神社 Guesser</title>
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css"
    rel="stylesheet"
    integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC"
    crossorigin="anonymous"
  />
  <style>
    body {
      background-color: #f0f8ff;
      font-family: 'Comic Sans MS', cursive, sans-serif;
      color: #333;
      text-align: center;
      padding: 20px;
    }

    h1 {
      font-size: 3rem;
      font-weight: bold;
      color: #ff4500;
      text-shadow: 2px 2px #ffa07a;
    }

    h2 {
      font-size: 2rem;
      color: #1e90ff;
      margin-bottom: 20px;
    }

    button {
      background: linear-gradient(45deg, #ff7f50, #ff4500);
      color: #fff;
      border: none;
      padding: 10px 20px;
      font-size: 1.2rem;
      border-radius: 10px;
      cursor: pointer;
      transition: transform 0.2s, box-shadow 0.2s;
    }

    button:hover {
      transform: scale(1.1);
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
    }

    #options button {
      margin: 10px;
    }

    #loading {
      font-size: 1.5rem;
      color: #ff6347;
    }

    #map-container img {
      border: 5px solid #1e90ff;
      border-radius: 15px;
      margin-top: 20px;
    }

    #scoreList {
      list-style: none;
      padding: 0;
    }

    #scoreList li {
      background: #ffe4b5;
      margin: 10px auto;
      padding: 10px;
      border-radius: 5px;
      box-shadow: 2px 2px 5px rgba(0, 0, 0, 0.2);
    }
  </style>
</head>
<body>
  <h1>神社 Guesser</h1>

  <div class="game-mode" id="game-mode-selection">
    <h2>ゲームモードを選択してください</h2>
    <button onclick="startGame('guess-location')">神社の場所を当てる</button>
    <button onclick="startGame('guess-name')">どれがあてはまる神社？</button>
  </div>

  <div class="question" id="question" style="display: none;">
    <h2 id="game-title"></h2>
    <p id="question-text">ここに問題が表示されます。</p>
    <div id="loading">読み込み中...</div>
    <div id="options" style="display: none;"></div>
    <div id="map-container" style="display: none;">
      <img src="Japanmap.svg" id="japan-map" alt="日本地図" width="800" height="800">
    </div>
    <button id="submit-button" onclick="submitAnswer()" style="display: none;">決定</button>
  </div>

  <h1>Scoreboard</h1>
  <button id="loadScores">スコアを取得する</button>
  <ul id="scoreList"></ul>
</body>

<script>
  const apiBaseUrl = 'https://script.google.com/macros/s/AKfycbw5cStUtPAC8pOm3ytdgtcSJWTu0E-5Ljc0bpX07yyQ7WzBYbHZSmvMuFkW0ByBf87J/exec'; // APIのベースURL
  let currentGameMode = null;
  let currentQuestions = [];
  let currentIndex = 0;
  let currentScore = 0;
  let selectedPosition = null;

  const LAT_MIN = 24.0;
  const LAT_MAX = 46.0;
  const LON_MIN = 123.0;
  const LON_MAX = 146.0;

  // ゲームを開始
  async function startGame(mode) {
    currentGameMode = mode;
    currentScore = 0;
    currentIndex = 0;

    document.getElementById('game-mode-selection').style.display = 'none';
    document.getElementById('loading').style.display = 'block';

    try {
      await fetchQuestions(); // 10問分のデータを取得
      document.getElementById('loading').style.display = 'none';
      document.getElementById('question').style.display = 'block';

      if (mode === 'guess-location') {
        document.getElementById('game-title').textContent = '神社の場所を当てる';
        document.getElementById('map-container').style.display = 'block';
      } else {
        document.getElementById('game-title').textContent = 'どれが正しい神社？';
        document.getElementById('options').style.display = 'block';
      }

      displayQuestion();
    } catch (error) {
      alert('データの取得に失敗しました。');
      console.error(error);
    }
  }

  // 問題を10問分取得
  async function fetchQuestions() {
    const response = await fetch(`${apiBaseUrl}?mode=game&count=10`);
    const data = await response.json();
    currentQuestions = data.questions;
  }

  // 現在の問題を表示
  function displayQuestion() {
    const question = currentQuestions[currentIndex+1];
    const questionText = document.getElementById('question-text');

    if (currentGameMode === 'guess-location') {
      questionText.textContent = `この神社はどこにありますか？ (${question['名称']}, 祭神: ${question['祭神']}, 創建: ${question['創建']}, 旧社格: ${question['旧社格']}, 様式: ${question['様式']})`;
      resetMap();
    } else {
      questionText.textContent = `次のうち、あてはまる神社の名前はどれですか？ (祭神: ${question['祭神']}, 創建: ${question['創建']}, 旧社格: ${question['旧社格']}, 様式: ${question['様式']})`;
      displayOptions(question);
    }
  }

  // 地図をリセット
  function resetMap() {
    const map = document.getElementById('japan-map');
    map.addEventListener('click', handleMapClick);
  }

  // 地図クリック処理
  function handleMapClick(event) {
    const rect = event.target.getBoundingClientRect();
    const x = event.clientX - rect.left;
    const y = event.clientY - rect.top;

    selectedPosition = { x, y };

    const existingPin = document.getElementById('selected-pin');
    if (existingPin) existingPin.remove();

    const pin = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
    pin.setAttribute('id', 'selected-pin');
    pin.setAttribute('cx', x);
    pin.setAttribute('cy', y);
    pin.setAttribute('r', 5);
    pin.setAttribute('fill', 'blue');
    event.target.appendChild(pin);
  }

  // 選択肢を表示
  function displayOptions(question) {
    const optionsDiv = document.getElementById('options');
    optionsDiv.innerHTML = '';

    const correctOption = document.createElement('button');
    correctOption.textContent = question['名称'];
    correctOption.onclick = () => handleAnswer(true);

    const wrongOptions = shuffle(
      currentQuestions
        .filter(q => q['名称'] !== question['名称'])
        .slice(0, 3)
    ).map(wrong => {
      const btn = document.createElement('button');
      btn.textContent = wrong['名称'];
      btn.onclick = () => handleAnswer(false);
      return btn;
    });

    const allOptions = shuffle([correctOption, ...wrongOptions]);
    allOptions.forEach(option => optionsDiv.appendChild(option));
  }

  // 回答を処理
  function handleAnswer(isCorrect) {
    if (isCorrect) {
      currentScore += 10;
      alert('正解です！');
    } else {
      alert(`不正解！正解は ${currentQuestions[currentIndex]['名称']} です。`);
    }

    nextQuestion();
  }

  // 次の問題に進む
  function nextQuestion() {
    currentIndex++;
    if (currentIndex < currentQuestions.length) {
      displayQuestion();
    } else {
      endGame();
    }
  }

  // ゲーム終了
  function endGame() {
    const playerName = prompt('名前を入力してください:');
    saveScore(playerName, currentScore);
    alert(`ゲーム終了！合計スコア: ${currentScore}`);
    location.reload();
  }

  // スコアを保存
  async function saveScore(playerName, score) {
    try {
      const response = await fetch(`https://script.google.com/macros/s/AKfycbyq1eRzCd_gfZzu4V2fGS0Jg6bvXYDsbHOWTUfX5bYeOt4xcfld_R1SSo3sfRSsBozj/exec`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ name: playerName, score: score }),
      });

      if (!response.ok) {
        throw new Error('スコアの保存に失敗しました。');
      }
    } catch (error) {
      console.error(error);
    }
  }

  // 配列をシャッフル
  function shuffle(array) {
    return array.sort(() => Math.random() - 0.5);
  }
</script>
  <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM"
      crossorigin="anonymous"
    ></script>
</html>

