<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>神社 Guesser</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
    }
    .game-mode, .question, .scoreboard {
      margin-bottom: 20px;
    }
    button {
      padding: 10px 20px;
      font-size: 16px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }
    table, th, td {
      border: 1px solid #ddd;
    }
    th, td {
      padding: 8px;
      text-align: left;
    }
    #map-container {
      width: 100%;
      max-width: 800px;
      margin: auto;
    }
    #japan-map {
      width: 100%;
      height: auto;
      border: 1px solid #ddd;
    }
    #loading {
      display: none;
      font-size: 18px;
      color: #555;
    }
  </style>
</head>
<body>
  <h1>神社 Guesser</h1>

  <div class="game-mode" id="game-mode-selection">
    <h2>ゲームモードを選択してください</h2>
    <button onclick="startGame('guess-location')">神社の場所を当てる</button>
    <button onclick="startGame('guess-name')">どれが正しい神社？</button>
  </div>

  <div class="question" id="question" style="display: none;">
    <h2 id="game-title"></h2>
    <p id="question-text">ここに問題が表示されます。</p>
    <div id="loading">読み込み中...</div>
    <div id="options" style="display: none;"></div>
    <div id="map-container" style="display: none;">
        <img src="Japanmap.svg" id="japan-map" alt="日本地図" width="800" height="800">
    </div>
    <button id="submit-button" onclick="submitAnswer()" style="display: none;">決定</button>
  </div>

   <h1>Scoreboard</h1>
  <button id="loadScores">スコアを取得する</button>
  <ul id="scoreList"></ul>
  </div>

  <script>
    const apiBaseUrl = 'https://script.google.com/macros/s/AKfycbw5cStUtPAC8pOm3ytdgtcSJWTu0E-5Ljc0bpX07yyQ7WzBYbHZSmvMuFkW0ByBf87J/exec'; // API URL を設定
    let currentGameMode = null;
    let currentQuestion = null;
    let currentOptions = [];
    let currentScore = 0;
    let attempts = 0;
    let selectedPosition = null;
    let isLoading = false;
    const LAT_MIN = 24.0;
    const LAT_MAX = 46.0;
    const LON_MIN = 123.0;
    const LON_MAX = 146.0;
    const loadScoresButton = document.getElementById("loadScores");
    const scoreList = document.getElementById("scoreList");

    loadScoresButton.addEventListener("click", async () => {
      const response = await fetch("https://script.google.com/macros/s/AKfycbw-wkcgQINOAJNsnNN82HOFCV9k0HoeNCPdFBCAQAoP-0aQNAHBeXAnY4VJvV39ZskX/exec"); // WebアプリのURL
      const scores = await response.json();

      // スコアリストをクリア
      scoreList.innerHTML = "";

      // スコアをリストに表示
      scores.forEach((score) => {
        const listItem = document.createElement("li");
        listItem.textContent = `${score.name}: ${score.score} (Date: ${score.date})`;
        scoreList.appendChild(listItem);
      });
    });
    // 緯度経度を x, y に変換
    function latLonToXY(lat, lon) {
      console.log(lat);
      lat = parseFloat(lat.toFixed(6)); // 小数点以下6桁
      lon = parseFloat(lon.toFixed(6));
      const a = ((lon - LON_MIN) / (LON_MAX - LON_MIN)) * 800;
      const b = 800 - ((lat - LAT_MIN) / (LAT_MAX - LAT_MIN)) * 800; // 上が小さい値
      console.log(a);
      return { x:a, y:b };
    }

    // ゲームを開始
    function startGame(mode) {
      currentGameMode = mode;
      currentScore = 0;
      attempts = 0;

      document.getElementById('game-mode-selection').style.display = 'none';
      document.getElementById('question').style.display = 'block';

      if (mode === 'guess-location') {
        document.getElementById('game-title').textContent = '神社の場所を当てる';
        document.getElementById('map-container').style.display = 'block';
      } else {
        document.getElementById('game-title').textContent = 'どれが正しい神社？';
        document.getElementById('options').style.display = 'block';
      }

      loadQuestion();
    }

    // 問題をロード
    async function loadQuestion() {
      if (isLoading) return; // 既にロード中の場合は処理をスキップ

      isLoading = true;
      document.getElementById('loading').style.display = 'block';

      try {
        const response = await fetch(`${apiBaseUrl}?mode=random`);
        const data = await response.json();

        currentQuestion = data.correct;
        currentOptions = shuffle([data.correct.name, ...data.wrong]);

        displayQuestion();
      } catch (error) {
        alert('問題の読み込み中にエラーが発生しました。');
      } finally {
        isLoading = false;
        document.getElementById('loading').style.display = 'none';
      }
    }

    // 問題を表示
    function displayQuestion() {
      const questionText = document.getElementById('question-text');

      if (currentGameMode === 'guess-location') {
        questionText.textContent = `この神社はどこにありますか？ (${currentQuestion.data['名称']}`+`祭神:${currentQuestion.data['祭神']}`+`創建:${currentQuestion.data['創建']}`+`旧社格:${currentQuestion.data['旧社格']}`+`建築様式:${currentQuestion.data['様式']})`;
        document.getElementById('submit-button').style.display = 'block';

        const map = document.getElementById('japan-map');
        map.addEventListener('click', event => {
          const rect = map.getBoundingClientRect();
          const x = event.clientX - rect.left;
          const y = event.clientY - rect.top;

          selectedPosition = { x, y };

          // 選択位置を示すピンを表示
          const existingPin = document.getElementById('selected-pin');
          if (existingPin) existingPin.remove();

          const pin = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
          pin.setAttribute('id', 'selected-pin');
          pin.setAttribute('cx', x);
          pin.setAttribute('cy', y);
          pin.setAttribute('r', 5);
          pin.setAttribute('fill', 'blue');
          map.appendChild(pin);
        });
      } else {
        questionText.textContent = `次のうち、正しい神社の名前はどれですか？ (`+`祭神:${currentQuestion.data['祭神']}`+`創建:${currentQuestion.data['創建']}`+`旧社格:${currentQuestion.data['旧社格']}`+`建築様式:${currentQuestion.data['様式']})`;
        const optionsDiv = document.getElementById('options');
        optionsDiv.innerHTML = '';
        currentOptions.forEach(option => {
          const button = document.createElement('button');
          button.textContent = option;
          button.onclick = () => checkAnswer(option);
          optionsDiv.appendChild(button);
        });
      }
    }

    // 答えを送信
    function submitAnswer() {
      if (!selectedPosition) {
        alert('地図にピンを刺してください。');
        return;
      }
      
      const shrinePosition = latLonToXY(currentQuestion.data['北緯'],currentQuestion.data['東経']); // 例として神社の座標 (SVG内の位置に対応)
      const dx = selectedPosition.x - shrinePosition.x;
      const dy = selectedPosition.y - shrinePosition.y;
      const distance = Math.sqrt(dx ** 2 + dy ** 2);

      const score = Math.max(0, 100 - Math.floor(distance / 5)); // 距離に応じたスコア計算
      currentScore += score;

      alert(`得点: ${score}点`);

      attempts++;
      if (attempts < 10) {
        loadQuestion();
      } else {
        endGame();
      }
    }

    // 答えをチェック
    function checkAnswer(selected) {
      if (selected === currentQuestion.name) {
        alert('正解！');
        currentScore += 10;
      } else {
        alert(`不正解！正解は ${currentQuestion.name} です。`);
      }

      attempts++;
      if (attempts < 10) {
        loadQuestion();
      } else {
        endGame();
      }
    }

    // ゲーム終了
    function endGame() {
      const playerName = prompt('名前を入力してください:');
      saveScore(playerName, currentScore);

      alert(`ゲーム終了！合計スコア: ${currentScore}`);
      location.reload();
    }

    // スコアを保存
    async function saveScore(playerName, score) {
      await fetch("https://script.google.com/macros/s/AKfycbw-wkcgQINOAJNsnNN82HOFCV9k0HoeNCPdFBCAQAoP-0aQNAHBeXAnY4VJvV39ZskX/exec", {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ playerName, score }),
      });
    }

    // 配列をランダムに並び替える
    function shuffle(array) {
      return array.sort(() => Math.random() - 0.5);
    }
  </script>
</body>
</html>

